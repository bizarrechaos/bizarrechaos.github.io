---
layout: post
title: "Malware Code Analysis: Anchor_Linux"
date:	2020-08-07 23:00
categories:
    - posts
tags:
    - malware_analysis
    - re
---

# Overview

In my last post I analysed Anchor_Linux.  
I want to get a bit deeper into the actual code of this binary and try and find where the things we saw are happening.  

# Analysis Summary

To get started with analysing this code I fired up (ghidra)[https://ghidra-sre.org/], created a new project, added the binary and double clicked it to start analysis.

To start off I used the string search to look for `/etc/crontab`.
I found the function contianing the reference to `/etc/crontab` as well as the cronjob string itself.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/install_crontab.png)

I then followed the function references up and found the function that runs install_crontab function and the get_processes function.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/discovery_and_persistence.png)

In get_processes we see functions to get all of the processes from `/proc`.  
We then see a function that takes those processes and prints the `/proc/$PID/cmdline`.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/get_processes.png)

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/get_proc.png)

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/get_proc_cli.png)

Following the references to the discovery_and_persistence function we get to the main function.  
In this main function we see a lot of debug information left in by the bad actors, as well as logging functionality. It seems this malware is actively being developed.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/main_debug_log.png)

Further down in the main function the process forks.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/fork.png)

This is the section where we start to see the Anchor_DNS code.  
Digging into this function we get to a function that is building the Anchor_DNS string we saw in our previous analysis. `/anchor_linux/hostname_version/.client_id/#/LVER/1001/public_ip/payload`

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/host_string.png)

This function builds this string piece by piece, which isn't suprising when we see that the function that gets the hosts public IP is called from here.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/public_ip.png)

Once the string is built it then gets sent off to a function that builds and makes the DNS request to send this data out.

Furthermore we can see in the codes strings and hexdump where all these urls are.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/url_strings.png)

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/hexdump_ip_urls.png)

I also looked for the smb reference that we saw in the strings from our previous analysis and found the following.

![]({{ site.url }}/attachments/c721189a2b89cd279e9a033c93b8b5017dc165cba89eff5b8e1b5866195518bc/smb.png)

There appears to be functionality for smb, ftp, and numerous connectivity methods built into this malware. However at this time it does not appear that they are being used actively. In the future, this will more than likely be used for network discovery and lateral movement that can be done cross platform using Linux and Windows malware variants.